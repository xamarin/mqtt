# Upload Stage

stages:
- stage : Package
  dependsOn:         
  - Test
  - Compliance
  jobs:
  - job: Push
    displayName: Pack & Push
    timeoutInMinutes: 10
    pool:
      name: $(WindowsPoolName)
    steps:
    - checkout: self

    - task: DownloadBuildArtifacts@0
      displayName: Download Packages
      inputs:
        artifactName: packages
        downloadPath: '$(Build.ArtifactStagingDirectory)'

    - task: NuGetCommand@2
      displayName: 'NuGet Update'
      inputs:
        command: custom
        arguments: 'update -self'

    - task: NuGetCommand@2
      displayName: Push Packages
      continueOnError: true
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], variables['MainBranch']))
      inputs:
        command: push
        packagesToPush: '$(Build.ArtifactStagingDirectory)/packages/*.nupkg'
        nuGetFeedType: external
        publishFeedCredentials: 'xamarin-impl public feed'
